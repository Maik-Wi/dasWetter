<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DWD Wetter ‚Äì Playful PWA (Client-only)</title>
  <meta name="description" content="Reine Client-PWA: DWD-Daten √ºber Bright Sky, SVG-Charts, Dark/Light, DE/EN." />
  <meta name="theme-color" content="#0b0f19" />
  <link rel="manifest" href="manifest.webmanifest">
  <link rel="icon" href="icons/icon-32.png" sizes="32x32">
  <link rel="apple-touch-icon" href="icons/icon-192.png">
  <style>
    /* 
     * This file is licensed under GPL-3.0-or-later.
     * Third-party licenses:
     * - Meteocons subset (MIT ¬© Bas Milius) embedded below.
     * - DWD Open Data requires CC BY 4.0 attribution (credit shown in footer).
     */

    :root{
      --bg:#0b0f19; --panel:#121826; --text:#e6ecf2; --muted:#a9b4c0;
      --accent:#7dd3fc; --danger:#ff6b6b; --ok:#22c55e; --ring:#2b3448;
      --radius:16px; --gap:12px;
      --bg-layers: radial-gradient(1200px 600px at 70% -10%, rgba(125,211,252,.12), transparent 60%), var(--bg);
      --hero-bg-layers: linear-gradient(135deg, rgba(125,211,252,.18), rgba(59,130,246,.05) 60%), var(--panel);
      --font: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", "Liberation Sans", sans-serif;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      color-scheme: dark;
    }
    @media (prefers-color-scheme: light){
      :root{ --bg:#f6f8fb; --panel:#fff; --text:#121826; --muted:#4b5563; --accent:#0369a1; --ring:#e5e7eb; --bg-layers: radial-gradient(1200px 600px at 70% -10%, rgba(3,105,161,.08), transparent 60%), var(--bg); --hero-bg-layers: linear-gradient(135deg, rgba(3,105,161,.08), rgba(15,118,110,.05) 65%), var(--panel); color-scheme: light;}
      meta[name="theme-color"]{ content:#f6f8fb; }
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0}
    body{
      font-family:var(--font);
      background:var(--bg-layers, var(--bg));
      background-color:var(--bg);
      background-repeat:no-repeat;
      color:var(--text); line-height:1.35; -webkit-tap-highlight-color: transparent;
      transition:background-color .6s ease;
    }
    a{ color:var(--accent); text-decoration:none }
    .app{ max-width:1000px; margin:0 auto; padding:16px; display:grid; gap:var(--gap) }
    header{ display:grid; gap:8px }
    .top{ display:flex; gap:10px; align-items:center; justify-content:space-between }
    .brand{ display:flex; align-items:center; gap:10px; font-weight:800; letter-spacing:.2px }
    .pill{ display:inline-flex; gap:8px; align-items:center; border:1px solid var(--ring); background:var(--panel); border-radius:999px; padding:6px 10px }
    .controls{ display:flex; flex-wrap:wrap; gap:8px }
    .btn{ border:1px solid var(--ring); background:var(--panel); color:var(--text); padding:8px 12px; border-radius:12px; cursor:pointer; font-weight:700 }
    .btn:active{ transform:translateY(1px) }
    input[type="text"]{ background:var(--panel); border:1px solid var(--ring); color:var(--text); padding:8px 12px; border-radius:12px; min-width:220px }
    .card{ background:var(--panel); border:1px solid var(--ring); border-radius:var(--radius); padding:14px }
    main{ display:grid; gap:var(--gap) }
    .hero{
      display:grid;
      grid-template-columns:auto 1fr auto;
      align-items:start;
      align-content:start;
      gap:12px;
      position:relative;
      overflow:hidden;
      background:var(--hero-bg-layers, var(--panel));
      background-size:cover;
      background-position:center;
      background-repeat:no-repeat;
      transition:background 1s ease;
      min-height:max(320px, 60vh);
      padding:32px;
    }
    .hero>*{ position:relative; z-index:1; }
    .hero h1{ margin:0; font-size:28px }
    .hero .meta{ color:var(--muted); font-size:14px }
    .hero .big{ font-size:56px; font-weight:900; letter-spacing:-.02em }
    .hero-icon{ color:var(--text); display:block; }
    .hero-icon use{ fill:currentColor; stroke:currentColor; }
    .card svg use{ fill:currentColor; stroke:currentColor; }

    .grid-2{ display:grid; gap:var(--gap) }
    @media (min-width: 860px){ .grid-2{ grid-template-columns: 1.2fr .8fr } }

    .legend{ display:flex; gap:12px; align-items:center; color:var(--muted); font-size:13px; flex-wrap:wrap; margin-bottom:6px }
    .dot{ width:10px; height:10px; border-radius:50%; background:var(--accent); display:inline-block }
    .bar{ width:10px; height:10px; background:var(--muted); display:inline-block }
    .chart{ width:100%; height:240px; display:block }

    .daily{ display:grid; gap:8px }
    .row{ display:grid; grid-template-columns:auto 1fr auto; gap:10px; align-items:center; padding:8px 10px; border:1px dashed var(--ring); border-radius:12px }
    .minmax{ --h:6px; height:var(--h); background:linear-gradient(90deg, rgba(125,211,252,.2), transparent); border-radius:999px; position:relative }
    .thumb{ position:absolute; top:-6px; transform:translateX(-50%); display:flex; flex-direction:column; align-items:center; gap:2px }

    footer{ color:var(--muted); font-size:12px }
    footer summary{ cursor:pointer; color:var(--text); font-weight:700; font-size:13px; }
    footer summary:focus-visible{ outline:2px solid var(--accent); outline-offset:4px }
    .credits-body{ display:grid; gap:6px; margin-top:8px }
    .credits-body p{ margin:0 }
    .kbd{ font-family:var(--mono); padding:.1em .4em; border:1px solid var(--ring); border-radius:6px; background:var(--panel) }
    .hidden{ display:none !important }
  </style>

  <!-- ===== Inline SVG Sprite: Meteocons subset (MIT ¬© Bas Milius) ===== -->
  <svg xmlns="http://www.w3.org/2000/svg" style="display:none">
    <symbol id="i-clear-day" viewBox="0 0 24 24"><circle cx="12" cy="12" r="5"/><g stroke="currentColor" fill="none" stroke-linecap="round" stroke-width="2"><path d="M12 1v3M12 20v3M4.2 4.2l2.1 2.1M17.7 17.7l2.1 2.1M1 12h3M20 12h3M4.2 19.8l2.1-2.1M17.7 6.3l2.1-2.1"/></g></symbol>
    <symbol id="i-clear-night" viewBox="0 0 24 24"><path d="M20 14a8 8 0 1 1-8-8 6 6 0 0 0 8 8z"/></symbol>
    <symbol id="i-partly-cloudy-day" viewBox="0 0 24 24"><circle cx="8" cy="10" r="3"/><path d="M4 16h12a4 4 0 0 0-4-4 5 5 0 0 0-8 4z"/></symbol>
    <symbol id="i-cloudy" viewBox="0 0 24 24"><path d="M5 16h10a4 4 0 0 0-1-7 5 5 0 0 0-9 3 3 3 0 0 0 0 4z"/></symbol>
    <symbol id="i-rain" viewBox="0 0 24 24"><path d="M5 15h11a4 4 0 0 0-1-7 5 5 0 0 0-9 3 3 3 0 0 0-1 4z"/><path d="M8 18l-1 3M12 18l-1 3M16 18l-1 3" /></symbol>
    <symbol id="i-snow" viewBox="0 0 24 24"><path d="M12 3v18M3 12h18M5 7l14 10M5 17L19 7"/></symbol>
    <symbol id="i-clock" viewBox="0 0 24 24"><circle cx="12" cy="12" r="9" fill="none" stroke="currentColor" stroke-width="2"/><path d="M12 7v5l3 3" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></symbol>
    <symbol id="i-wind" viewBox="0 0 24 24"><path d="M3 8h10a2 2 0 1 0-2-2M3 12h16a2 2 0 1 1-2 2M3 16h10"/></symbol>
    <symbol id="i-humidity" viewBox="0 0 24 24"><path d="M12 3s6 6 6 10a6 6 0 0 1-12 0c0-4 6-10 6-10z"/></symbol>
    <symbol id="i-pressure" viewBox="0 0 24 24"><path d="M12 21a9 9 0 1 0-9-9 9 9 0 0 0 9 9zM12 12l4-3"/></symbol>
  </svg>
</head>
<body>
  <div class="app">
    <header>
      <div class="top">
        <div class="brand">
          <span class="pill">üå§Ô∏è</span>
          <span style="font-size:18px">Wetter</span>
          <span class="pill" id="buildInfo"></span>
        </div>
        <div class="controls">
          <button class="btn" id="geoBtn">üìç <span data-i="useMyLocation">Standort nutzen</span></button>
          <input id="coord" type="text" placeholder="lat,lon (z. B. 52.52,13.40)" aria-label="Koordinaten"/>
          <button class="btn" id="goBtn">Go</button>
          <button class="btn" id="langBtn">DE/EN</button>
        </div>
      </div>
    </header>

    <main>
      <section class="card hero" aria-live="polite">
        <div><svg class="hero-icon" width="64" height="64" viewBox="0 0 24 24"><use id="heroIcon" href="#i-clear-day"/></svg></div>
        <div>
          <h1 id="place">‚Äî</h1>
          <div class="meta" id="banter">‚Äî</div>
        </div>
        <div>
          <div class="big" id="temp">‚Äî¬∞</div>
          <div class="meta" id="apparent">‚Äî</div>
        </div>
      </section>

      <section class="card">
        <div class="legend">
          <span class="dot"></span><span data-i="legendTemp">Temperatur (¬∞C)</span>
          <span class="bar"></span><span data-i="legendPrec">Niederschlag (mm/h)</span>
        </div>
        <svg id="hourlyChart" class="chart" role="img" aria-label="Stundenprognose"></svg>
      </section>

      <section class="grid-2">
        <div class="card">
          <h3 style="margin-top:0" data-i="nextDaysTitle">N√§chste Tage</h3>
          <div id="daily" class="daily"></div>
        </div>
        <div class="card">
          <h3 style="margin-top:0" data-i="detailsTitle">Details</h3>
          <div style="display:grid; gap:8px">
            <div class="row"><svg width="20" height="20"><use href="#i-clock"/></svg><div data-i="lastUpdated">Aktualisierung</div><div id="updated">‚Äî</div></div>
            <div class="row"><svg width="20" height="20"><use href="#i-wind"/></svg><div data-i="wind">Wind</div><div id="wind">‚Äî</div></div>
            <div class="row"><svg width="20" height="20"><use href="#i-humidity"/></svg><div data-i="humidity">Luftfeuchte</div><div id="humidity">‚Äî</div></div>
            <div class="row"><svg width="20" height="20"><use href="#i-pressure"/></svg><div data-i="pressure">Luftdruck</div><div id="pressure">‚Äî</div></div>
          </div>
        </div>
      </section>
    </main>

    <footer class="card">
      <details class="credits" id="creditsDetails">
        <summary>Credits &amp; Lizenzen</summary>
        <div class="credits-body">
          <p>
            Wetterdaten: ¬© Deutscher Wetterdienst (DWD), CC BY 4.0 ‚Äì Produkt: MOSMIX.
            Zugriff via <a href="https://brightsky.dev" target="_blank" rel="noopener">Bright Sky</a> (CORS-f√§hige JSON-API).
          </p>
          <p>Meteocons Icons (MIT, ¬© Bas Milius) ‚Äì eingebettetes Subset. Unser App-Code: GPL-3.0-or-later.</p>
          <p>Privatmodus-freundlich: Kein Tracking, keine Cookies.</p>
        </div>
      </details>
    </footer>
  </div>

<script>
/* GPL-3.0-or-later ‚Äî ¬© 2025 Your Name */

const I18N = {
  de: {
    useMyLocation:"Standort nutzen",
    legendTemp:"Temperatur (¬∞C)",
    legendPrec:"Niederschlag (mm/h)",
    nextDaysTitle:"N√§chste Tage",
    detailsTitle:"Details",
    wind:"Wind", humidity:"Luftfeuchte", pressure:"Luftdruck",
    lastUpdated:"Letztes Update",
    updated:(t)=>`Aktualisiert: ${t}`,
    unknownPlace:"Unbekannter Ort"
  },
  en: {
    useMyLocation:"Use my location",
    legendTemp:"Temperature (¬∞C)",
    legendPrec:"Precipitation (mm/h)",
    nextDaysTitle:"Next days",
    detailsTitle:"Details",
    wind:"Wind", humidity:"Humidity", pressure:"Pressure",
    lastUpdated:"Last update",
    updated:(t)=>`Updated: ${t}`,
    unknownPlace:"Unknown place"
  }
};
let lang = (navigator.language||"de").toLowerCase().startsWith("de") ? "de" : "en";
const $ = s=>document.querySelector(s); const $$ = s=>document.querySelectorAll(s);
function t(key, ...a){ const v=I18N[lang][key]; return typeof v==="function"?v(...a):v||key; }
function applyI18n(){ $$("[data-i]").forEach(el=>{ const k=el.getAttribute("data-i"); el.textContent=t(k); }); }

const BrightSky = {
  base:"https://api.brightsky.dev",
  async current(lat, lon){
    const r = await fetch(`${this.base}/current_weather?lat=${lat}&lon=${lon}`, {cache:"no-store"});
    if(!r.ok) throw new Error("current_weather failed");
    return r.json();
  },
  async hourly(lat, lon, hours=48){
    const now = new Date();
    const from = now.toISOString().slice(0,19)+"Z";
    const until = new Date(now.getTime()+hours*3600e3).toISOString().slice(0,19)+"Z";
    const url = `${this.base}/weather?lat=${lat}&lon=${lon}&date=${from}&last_date=${until}`;
    const r = await fetch(url, {cache:"no-store"});
    if(!r.ok) throw new Error("weather failed");
    return r.json();
  },
  async daily(lat, lon, days=8){
    const hours = (await this.hourly(lat, lon, 24*days)).weather||[];
    const map = new Map();
    for(const w of hours){
      const ts = w.timestamp || w.time || w.date;
      if(!ts) continue;
      const d = ts.slice(0,10);
      const e = map.get(d)||{temps:[], prec:0, sample:w};
      if(typeof w.temperature==="number") e.temps.push(w.temperature);
      e.prec += (w.precipitation||w.precipitation_rate||0);
      map.set(d,e);
    }
    const out=[]; for(const [d,e] of map){
      const min = e.temps.length?Math.min(...e.temps):null;
      const max = e.temps.length?Math.max(...e.temps):null;
      out.push({date:d, tmin:min, tmax:max, sample:e.sample, prec:e.prec});
    }
    return out.sort((a,b)=>a.date.localeCompare(b.date)).slice(0,days);
  }
};

const S = { coords:null, place:"‚Äî", placeFallback:false, current:null, hourly:[], daily:[] };

const TEST_COORDS = {
  berlin:{lat:52.520008, lon:13.404954},
  m√ºnchen:{lat:48.137154, lon:11.576124},
  frankfurt:{lat:50.110924, lon:8.682127},
  kiel:{lat:54.323293, lon:10.122765}
};
window.TEST_COORDS = TEST_COORDS;

function fmt(n,d=0){ return (n==null||Number.isNaN(n))?"‚Äî":Number(n).toFixed(d); }
function dir(deg){ const dirs=["N","NE","E","SE","S","SW","W","NW","N"]; return dirs[Math.round((deg||0)/45)]; }
function dayShort(dateStr){ const d = new Date(dateStr+"T12:00:00Z"); return d.toLocaleDateString(lang, {weekday:"short"}); }
function timeHM(ts){ const d = new Date(ts); return d.toLocaleTimeString(lang, {hour:"2-digit", minute:"2-digit"}); }

const ICON_MAP = {
  "clear-day":"i-clear-day","clear-night":"i-clear-night",
  "partly-cloudy-day":"i-partly-cloudy-day","partly-cloudy-night":"i-partly-cloudy-day",
  "cloudy":"i-cloudy","fog":"i-cloudy","rain":"i-rain","sleet":"i-snow","snow":"i-snow","wind":"i-wind"
};

const ICON_TO_MOOD = {
  "clear-day":"clear","clear-night":"clear",
  "partly-cloudy-day":"cloudy","partly-cloudy-night":"cloudy",
  "cloudy":"cloudy","fog":"fog","mist":"fog",
  "rain":"rain","sleet":"rain","hail":"rain",
  "snow":"snow","wind":"clear","thunderstorm":"storm","storm":"storm"
};

const GARDEN_BASES = {
  dawn:{
    base:"#0b1320",
    baseLight:"#f8f5ff",
    skyTop:"#fde4ff",
    skyBottom:"#c3ddff",
    highlight:"radial-gradient(1600px 1200px at 50% -30%, rgba(253,186,116,.18), transparent 65%)",
    overlayDark:"linear-gradient(180deg, rgba(8,12,22,.58) 0%, rgba(8,11,19,.86) 100%)",
    overlayLight:"linear-gradient(180deg, rgba(255,255,255,.7) 0%, rgba(246,248,251,.92) 100%)",
    meta:"#0b1320"
  },
  day:{
    base:"#07101d",
    baseLight:"#f1fbff",
    skyTop:"#c7e9ff",
    skyBottom:"#8de4c8",
    highlight:"radial-gradient(1600px 1200px at 60% -25%, rgba(148,221,255,.2), transparent 70%)",
    overlayDark:"linear-gradient(180deg, rgba(4,7,15,.55) 0%, rgba(7,12,22,.88) 100%)",
    overlayLight:"linear-gradient(180deg, rgba(255,255,255,.65) 0%, rgba(246,248,251,.92) 100%)",
    meta:"#07101d"
  },
  dusk:{
    base:"#140d23",
    baseLight:"#f5f0ff",
    skyTop:"#f5d0fe",
    skyBottom:"#94a3f5",
    highlight:"radial-gradient(1600px 1200px at 40% -20%, rgba(255,145,164,.2), transparent 70%)",
    overlayDark:"linear-gradient(180deg, rgba(10,8,20,.65) 0%, rgba(12,9,25,.88) 100%)",
    overlayLight:"linear-gradient(180deg, rgba(255,255,255,.6) 0%, rgba(246,248,251,.9) 100%)",
    meta:"#140d23"
  },
  night:{
    base:"#070b16",
    baseLight:"#e8efff",
    skyTop:"#0f172a",
    skyBottom:"#312e81",
    highlight:"radial-gradient(1600px 1200px at 50% -35%, rgba(76,29,149,.25), transparent 70%)",
    overlayDark:"linear-gradient(180deg, rgba(6,9,20,.7) 0%, rgba(4,6,15,.92) 100%)",
    overlayLight:"linear-gradient(180deg, rgba(240,246,255,.72) 0%, rgba(226,232,240,.95) 100%)",
    meta:"#070b16"
  }
};

const GARDEN_MOODS = {
  clear:{ petal:"#f97316", accent:"#fde68a", leaf:"#22c55e", glow:"#fda4af", spark:"#fef08a" },
  cloudy:{ petal:"#38bdf8", accent:"#a855f7", leaf:"#34d399", glow:"#c4b5fd", spark:"#e9d5ff" },
  rain:{ petal:"#38bdf8", accent:"#0ea5e9", leaf:"#2dd4bf", glow:"#0284c7", spark:"#bae6fd" },
  snow:{ petal:"#f8fafc", accent:"#38bdf8", leaf:"#bae6fd", glow:"#e0f2fe", spark:"#e0f2fe" },
  fog:{ petal:"#cbd5f5", accent:"#94a3b8", leaf:"#94a3b8", glow:"#cbd5f5", spark:"#e2e8f0" },
  storm:{ petal:"#f472b6", accent:"#facc15", leaf:"#10b981", glow:"#7c3aed", spark:"#fde68a" }
};

function themeTimeSlot(date){
  const h = date.getHours();
  if(h>=5 && h<9) return "dawn";
  if(h>=9 && h<17) return "day";
  if(h>=17 && h<21) return "dusk";
  return "night";
}

function gardenMoodFromWeather(current){
  if(!current) return "cloudy";
  const icon = (current.icon||"").toLowerCase();
  const resolved = ICON_TO_MOOD[icon];
  if(resolved) return resolved;
  const summary = (current.condition||"").toLowerCase();
  if(summary.includes("snow")) return "snow";
  if(summary.includes("rain") || summary.includes("shower") || summary.includes("drizzle")) return "rain";
  if(summary.includes("storm") || summary.includes("thunder")) return "storm";
  if(summary.includes("fog") || summary.includes("mist")) return "fog";
  if(summary.includes("clear") || summary.includes("sun")) return "clear";
  return "cloudy";
}

function hashString(str){
  let h = 0;
  for(let i=0;i<str.length;i++){
    h = ((h<<5)-h) + str.charCodeAt(i);
    h |= 0;
  }
  return Math.abs(h) + 1;
}

function seededRandom(seed){
  let s = seed % 2147483647;
  if(s<=0) s += 2147483646;
  return function(){
    s = s * 16807 % 2147483647;
    return (s - 1) / 2147483646;
  };
}

function createGardenSvg(palette, seed){
  const rand = seededRandom(seed);
  const gradId = "g"+(seed%10000);
  const glowId = "gl"+(seed%10000);
  const stems = [];
  const blooms = [];
  const leaves = [];
  for(let i=0;i<7;i++){
    const baseX = rand()*90 + 5;
    const tipY = 38 + rand()*32;
    const ctrlX = baseX + (rand()-.5)*18;
    const ctrlY = tipY + (100 - tipY) * (0.45 + rand()*0.28);
    const topX = baseX + (rand()-.5)*10;
    const width = 0.6 + rand()*0.9;
    stems.push(`<path d="M${baseX.toFixed(2)} 100 Q ${ctrlX.toFixed(2)} ${ctrlY.toFixed(2)} ${topX.toFixed(2)} ${tipY.toFixed(2)}" stroke="${palette.leaf}" stroke-width="${width.toFixed(2)}" fill="none" stroke-linecap="round" stroke-opacity="0.85"/>`);
    const bloomRadius = 2.8 + rand()*3.2;
    blooms.push(`<circle cx="${topX.toFixed(2)}" cy="${(tipY-1.2-rand()*2.2).toFixed(2)}" r="${bloomRadius.toFixed(2)}" fill="${palette.petal}" fill-opacity="0.9" stroke="${palette.accent}" stroke-opacity="0.6" stroke-width="${(0.5+rand()*0.6).toFixed(2)}"/>`);
    if(rand()>0.35){
      const leafX = baseX + (rand()-.5)*14;
      const leafY = tipY + rand()*(100 - tipY - 6);
      const leafRx = 2.8 + rand()*4.2;
      const leafRy = 5 + rand()*7;
      const rot = (rand()-.5)*70;
      leaves.push(`<ellipse cx="${leafX.toFixed(2)}" cy="${leafY.toFixed(2)}" rx="${leafRx.toFixed(2)}" ry="${leafRy.toFixed(2)}" fill="${palette.leaf}" fill-opacity="0.22" transform="rotate(${rot.toFixed(2)} ${leafX.toFixed(2)} ${leafY.toFixed(2)})"/>`);
    }
  }
  const sparkles = [];
  for(let i=0;i<12;i++){
    const size = rand();
    const x = rand()*100;
    const y = rand()*60;
    const opacity = 0.12 + rand()*0.3;
    const radius = 0.25 + size*1.15;
    sparkles.push(`<circle cx="${x.toFixed(2)}" cy="${y.toFixed(2)}" r="${radius.toFixed(2)}" fill="${palette.spark || palette.accent}" fill-opacity="${opacity.toFixed(2)}"/>`);
  }
  const svg = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" preserveAspectRatio="xMidYMid slice">
    <defs>
      <linearGradient id="${gradId}" x1="0" y1="0" x2="0" y2="1">
        <stop offset="0%" stop-color="${palette.skyTop}"/>
        <stop offset="100%" stop-color="${palette.skyBottom}"/>
      </linearGradient>
      <radialGradient id="${glowId}" cx="50%" cy="30%" r="60%">
        <stop offset="0%" stop-color="${palette.glow || palette.accent}" stop-opacity="0.35"/>
        <stop offset="100%" stop-color="${palette.glow || palette.accent}" stop-opacity="0"/>
      </radialGradient>
    </defs>
    <rect width="100" height="100" fill="url(#${gradId})"/>
    <rect width="100" height="100" fill="url(#${glowId})"/>
    ${sparkles.join("")}
    ${leaves.join("")}
    ${stems.join("")}
    ${blooms.join("")}
  </svg>`;
  const compact = svg.replace(/\s+/g," ").trim();
  const encoded = encodeURIComponent(compact);
  return `url("data:image/svg+xml;charset=UTF-8,${encoded}")`;
}

function buildGardenTheme(current){
  const now = new Date(current && (current.timestamp || current.time || current.date) || Date.now());
  const slot = themeTimeSlot(now);
  const base = GARDEN_BASES[slot] || GARDEN_BASES.day;
  const moodKey = gardenMoodFromWeather(current);
  const mood = GARDEN_MOODS[moodKey] || GARDEN_MOODS.cloudy;
  const prefersLight = typeof window!=="undefined" && window.matchMedia && window.matchMedia("(prefers-color-scheme: light)").matches;
  const baseColor = prefersLight ? (base.baseLight || base.base) : base.base;
  const palette = {...base, ...mood, base: baseColor};
  const seedSource = `${slot}-${moodKey}-${Math.round((S.coords&&S.coords.lat||0)*100)}-${Math.round((S.coords&&S.coords.lon||0)*100)}-${now.getUTCDate()}`;
  const seed = hashString(seedSource);
  const svgLayer = createGardenSvg(palette, seed);
  const overlay = prefersLight ? palette.overlayLight : palette.overlayDark;
  const highlight = palette.highlight || "radial-gradient(1200px 600px at 70% -10%, rgba(255,255,255,.1), transparent 60%)";
  const layers = `${overlay}, ${svgLayer}, ${highlight}, var(--bg)`;
  return { layers, base: palette.base, accent: palette.accent, meta: palette.base };
}

function applyGardenTheme(){
  const root = document.documentElement;
  if(!root) return;
  if(!S.current){
    root.style.removeProperty("--hero-bg-layers");
    return;
  }
  const preset = buildGardenTheme(S.current);
  if(preset.layers){
    root.style.setProperty("--hero-bg-layers", preset.layers);
  }
  if(preset.base){
    root.style.setProperty("--bg", preset.base);
  }
  if(preset.accent){
    root.style.setProperty("--accent", preset.accent);
  }
  const themeMeta = document.querySelector('meta[name="theme-color"]');
  if(themeMeta && preset.base){
    themeMeta.setAttribute("content", preset.meta || preset.base);
  }
}

function requestPosition(options){
  return new Promise((resolve, reject)=>{
    if(!("geolocation" in navigator)){
      reject(new Error("geolocation unsupported"));
      return;
    }
    navigator.geolocation.getCurrentPosition(resolve, reject, options);
  });
}

async function resolvePlace(lat, lon){
  try{
    const locale = lang==="de"?"de":"en";
    const url = `https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${encodeURIComponent(lat)}&longitude=${encodeURIComponent(lon)}&localityLanguage=${locale}`;
    const res = await fetch(url, {cache:"no-store"});
    if(!res.ok) throw new Error("reverse geocode failed");
    const data = await res.json();
    const parts = [];
    const pushUnique = value=>{
      if(!value) return;
      const clean = String(value).trim();
      if(!clean) return;
      if(!parts.some(p=>p.toLowerCase()===clean.toLowerCase())) parts.push(clean);
    };
    pushUnique(data.city);
    pushUnique(data.locality);
    if(data.localityInfo && Array.isArray(data.localityInfo.administrative)){
      const admin = data.localityInfo.administrative.find(entry=>entry.order>=4 && entry.order<=6);
      pushUnique(admin && (admin.city || admin.name));
    }
    pushUnique(data.principalSubdivision);
    const country = data.countryName || data.countryCode;
    if(parts.length===0 && country) pushUnique(country);
    return parts.slice(0,2).join(", ") || parts[0] || country || null;
  }catch(err){
    console.warn("Reverse geocode failed", err);
    return null;
  }
}

const BANTER_LINES = {
  rain:[
    "Es pisst mehr als deine Nachbarn nach dem dritten Gl√ºhwein.",
    "Drau√üen regnet's wie aus 'ner kaputten Dachrinne ‚Äì viel Spa√ü damit.",
    "So nass, dass selbst deine Laune Schimmel ansetzt.",
    "Das ist kein Wetter, das ist 'ne gratis Dusche mit Dreckgarantie.",
    "Regen deluxe ‚Äì perfekt um jede Frisur in Sekunden zu ruinieren."
  ],
  snow:[
    "Schneechaos deluxe ‚Äì zieh was Warmes an, du Frostbeule.",
    "Mehr Pulver als in der Apr√®s-Ski-Bar, aber genauso nervig.",
    "Es flockt wie in einer kitschigen RomCom, nur ohne Happy End.",
    "Schuhe an, sonst frieren dir die Zehen ab wie schlechte Ausreden.",
    "So viel Schnee, dass selbst der Winterdienst weint."
  ],
  storm:[
    "Blitzt und rummst, beste Zeit um Dramatik zu √ºben.",
    "Der Wind schreit lauter als dein Wecker ‚Äì halt dich fest.",
    "Sturmstiefel an, sonst weht dich die Realit√§t um.",
    "Da drau√üen tobt 'ne Rockshow und du bist ohne Ticket.",
    "Mehr Orkan als Ordnung ‚Äì lass den Regenschirm gleich zu Hause."
  ],
  fog:[
    "Nebel wie in 'nem schlechten Tatort ‚Äì siehst nix, f√ºhlst nix.",
    "So neblig, dass selbst dein Navi erstmal nen Kaffee braucht.",
    "Alles grau, alles dicht ‚Äì willkommen im Berliner Sp√§tabend.",
    "Wenn du jetzt Auto f√§hrst, nimm gleich 'ne Nebelhupe mit.",
    "Dichter als ein Verschw√∂rungspodcast ‚Äì und doppelt nervig."
  ],
  heat:[
    "Es ist so hei√ü, dass sogar dein Humor schmilzt.",
    "Backofen-Feeling gratis ‚Äì du bist das Grillgut.",
    "Sonne pr√ºgelt dich weich, trink was bevor du klappst.",
    "Schwitz-Level: Sauna plus schlechter Smalltalk.",
    "Schattensucher werden heute zu echten √úberlebensk√ºnstlern."
  ],
  cold:[
    "Eiskalt ‚Äì deine Ausreden sollten wenigstens warm sein.",
    "So frostig, dass selbst dein Handy knirscht.",
    "K√§lter als der Blick deiner Ex, also zieh dich an.",
    "Die Luft bei√üt ‚Äì und nein, das ist kein Kompliment.",
    "Du bist gleich Tiefk√ºhlkost, wenn du da so rumstehst."
  ],
  clear:[
    "Sonne satt, also raus mit dir und tu so als h√§ttest du Vitamin D.",
    "Blauer Himmel, perfekte Kulisse f√ºr dein √úberheblichkeits-Selfie.",
    "Mieser Tag f√ºr Ausreden drinnen zu bleiben ‚Äì ab nach drau√üen.",
    "Klarer Himmel, dein Drama musst du selber mitbringen.",
    "Die Sonne ballert freundlich, g√∂nn dir wenigstens ne Sonnenbrille."
  ],
  cloud:[
    "Wolkensuppe, perfekt um miesepetrig zu gucken.",
    "So viel Grau, dass sogar Beton neidisch wird.",
    "Die Wolken h√§ngen tiefer als dein Energielevel.",
    "Stimmung wie Kantinenkaffee ‚Äì lau und fragw√ºrdig.",
    "Nix los am Himmel, also sorg du f√ºr Unterhaltung."
  ],
  default:[
    "Da drau√üen herrscht gerade Wetter f√ºr Leute ohne Modegeschmack.",
    "Der Himmel macht Faxen, pack dir wenigstens Laufschuhe ein.",
    "Diese Luft f√ºhlt sich an wie ein schlechter Witz vom Stammtisch.",
    "Wenn du jetzt rausgehst, beschwer dich hinterher nicht bei mir.",
    "Reicht f√ºrs Bier im Freien, aber frag nicht nach Stil."
  ]
};

function pickBanter(key){
  const list = BANTER_LINES[key] || BANTER_LINES.default;
  return list[Math.floor(Math.random()*list.length)];
}

function weatherBanter(cur){
  const icon = (cur.icon||"").toLowerCase();
  const temp = cur.temperature;
  const feels = cur.apparent_temperature ?? temp;
  if(icon.includes("rain") || icon.includes("sleet")){
    return pickBanter("rain");
  }
  if(icon.includes("snow")){
    return pickBanter("snow");
  }
  if(icon.includes("storm") || icon.includes("thunder")){
    return pickBanter("storm");
  }
  if(icon.includes("fog")){
    return pickBanter("fog");
  }
  if((feels??0) >= 28){
    return pickBanter("heat");
  }
  if((feels??0) <= 0){
    return pickBanter("cold");
  }
  if(icon.includes("clear")){
    return pickBanter("clear");
  }
  if(icon.includes("cloud")){
    return pickBanter("cloud");
  }
  return pickBanter("default");
}

function setHero(){
  const c = S.current; if(!c) return;
  const placeText = S.placeFallback ? t("unknownPlace") : (S.place || t("unknownPlace"));
  const iconId = ICON_MAP[c.icon] || "i-partly-cloudy-day";
  $("#heroIcon").setAttribute("href", "#"+iconId);
  $("#place").textContent = placeText;
  $("#temp").textContent = fmt(c.temperature,0)+"¬∞";
  const feelsLike = c.apparent_temperature ?? c.dew_point ?? null;
  $("#apparent").textContent = feelsLike==null ? "f√ºhlt sich an wie ‚Äî" : `f√ºhlt sich an wie ${fmt(feelsLike,0)}¬∞`;
  $("#banter").textContent = weatherBanter(c);
  const updatedAt = new Date(c.timestamp||Date.now());
  $("#updated").textContent = updatedAt.toLocaleString(lang);
  $("#wind").textContent = `${fmt(c.wind_speed,1)} m/s ${dir(c.wind_direction)}`;
  $("#humidity").textContent = `${fmt(c.relative_humidity,0)} %`;
  $("#pressure").textContent = `${fmt(c.pressure_msl,0)} hPa`;
  applyGardenTheme();
}

function renderHourlyChart(){
  const svg = $("#hourlyChart"); while(svg.firstChild) svg.removeChild(svg.firstChild);
  const W = svg.clientWidth || 640, H = svg.clientHeight || 240;
  svg.setAttribute("viewBox", `0 0 ${W} ${H}`);
  const m = {l:34, r:10, t:10, b:24}, w=W-m.l-m.r, h=H-m.t-m.b;

  const data = (S.hourly||[]).slice(0,48);
  if(data.length<2){ return; }
  const temps = data.map(d=>d.temperature??0);
  const precs = data.map(d=>d.precipitation??0);
  const tmin = Math.min(...temps), tmax = Math.max(...temps);
  const pmax = Math.max(1, ...precs);
  const x = i => m.l + (i/(data.length-1)) * w;
  const yT = v => m.t + (1-( (v-tmin)/Math.max(1,(tmax-tmin)) )) * (h*0.7);
  const yP = v => m.t + h*0.7 + (1-(v/Math.max(1,pmax))) * (h*0.3);

  // baseline
  const axis = document.createElementNS("http://www.w3.org/2000/svg","path");
  axis.setAttribute("d",`M${m.l} ${m.t+h*0.7} H${W-m.r}`);
  axis.setAttribute("stroke","currentColor"); axis.setAttribute("opacity",".3");
  svg.appendChild(axis);

  // precip bars
  data.forEach((d,i)=>{
    const bw = Math.max(2, w/Math.max(24,data.length));
    const x0 = x(i)-bw/2, y0 = yP(0), y1 = yP(d.precipitation||0);
    const bar = document.createElementNS("http://www.w3.org/2000/svg","rect");
    bar.setAttribute("x", x0); bar.setAttribute("y", Math.min(y0,y1));
    bar.setAttribute("width", bw); bar.setAttribute("height", Math.abs(y1-y0));
    bar.setAttribute("fill","currentColor"); bar.setAttribute("opacity",".35");
    svg.appendChild(bar);
    if(i%6===0){
      const lab = document.createElementNS("http://www.w3.org/2000/svg","text");
      lab.setAttribute("x", x(i)); lab.setAttribute("y", H-6);
      lab.setAttribute("text-anchor","middle"); lab.setAttribute("font-size","11"); lab.setAttribute("opacity",".6");
      lab.textContent = timeHM(d.timestamp||d.time||d.date||"");
      svg.appendChild(lab);
    }
  });

  // temp line
  const line = document.createElementNS("http://www.w3.org/2000/svg","path");
  let dAttr=""; data.forEach((d,i)=>{ const xx=x(i), yy=yT(d.temperature??0); dAttr+= (i?"L":"M")+xx+" "+yy+" "; });
  line.setAttribute("d", dAttr.trim());
  line.setAttribute("fill","none"); line.setAttribute("stroke","currentColor"); line.setAttribute("stroke-width","2");
  svg.appendChild(line);

  // points
  data.forEach((d,i)=>{
    const dot = document.createElementNS("http://www.w3.org/2000/svg","circle");
    dot.setAttribute("cx", x(i)); dot.setAttribute("cy", yT(d.temperature??0)); dot.setAttribute("r","3.5");
    dot.setAttribute("fill","currentColor");
    svg.appendChild(dot);
  });

  const tminText = document.createElementNS("http://www.w3.org/2000/svg","text");
  tminText.setAttribute("x", m.l); tminText.setAttribute("y", m.t+12); tminText.setAttribute("font-size","12"); tminText.setAttribute("opacity",".7");
  tminText.textContent = `min ${fmt(tmin,0)}¬∞  max ${fmt(tmax,0)}¬∞`;
  svg.appendChild(tminText);
}

function renderDaily(){
  const root = $("#daily"); root.innerHTML="";
  const days = S.daily||[];
  const all = days.flatMap(d => [d.tmin, d.tmax].filter(v=>v!=null));
  const gMin = Math.min(...all), gMax = Math.max(...all);
  const span = Math.max(1, gMax - gMin);

  days.forEach(d=>{
    const row = document.createElement("div"); row.className="row";
    const icon = document.createElementNS("http://www.w3.org/2000/svg","svg");
    icon.setAttribute("width","24"); icon.setAttribute("height","24");
    const use = document.createElementNS("http://www.w3.org/2000/svg","use");
    const iconId = (ICON_MAP[(d.sample&&d.sample.icon)||""] || "i-partly-cloudy-day");
    use.setAttribute("href","#"+iconId); icon.appendChild(use);

    const mid = document.createElement("div");
    const label = document.createElement("div"); label.textContent = dayShort(d.date);
    const bar = document.createElement("div"); bar.className="minmax";
    if(d.tmin!=null && d.tmax!=null){
      const start = ((d.tmin - gMin)/span)*100;
      const end = ((d.tmax - gMin)/span)*100;
      bar.style.background = `linear-gradient(90deg, rgba(125,211,252,.25) ${start}%, rgba(125,211,252,.25) ${end}%, transparent ${end}%)`;
      const thumbMin = document.createElement("div"); thumbMin.className="thumb";
      thumbMin.style.left = start+"%"; thumbMin.innerHTML = `<div class="kbd">${fmt(d.tmin,0)}¬∞</div>`;
      const thumbMax = document.createElement("div"); thumbMax.className="thumb";
      thumbMax.style.left = end+"%"; thumbMax.innerHTML = `<div class="kbd">${fmt(d.tmax,0)}¬∞</div>`;
      bar.appendChild(thumbMin); bar.appendChild(thumbMax);
    }
    mid.appendChild(label); mid.appendChild(bar);

    const right = document.createElement("div"); right.textContent = `${fmt(d.prec,1)} mm`;

    row.appendChild(icon); row.appendChild(mid); row.appendChild(right);
    root.appendChild(row);
  });
}

async function loadAll(lat, lon){
  S.coords = {lat, lon};
  const cur = await BrightSky.current(lat, lon);
  S.current = (cur||{}).weather || cur || {};
  const stationName =
    (cur && cur.station && (cur.station.name || cur.station.id || cur.station.identifier)) ||
    (cur && cur.source && (cur.source.station_name || cur.source.name)) ||
    (S.current && (S.current.station_name || S.current.station || S.current.source_station_name)) ||
    (cur && cur.city) ||
    null;
  let prettyPlace = await resolvePlace(lat, lon);
  if(prettyPlace){
    S.place = prettyPlace;
    S.placeFallback = false;
  }else if(stationName){
    S.place = stationName;
    S.placeFallback = false;
  }else{
    S.place = null;
    S.placeFallback = true;
  }
  const h = await BrightSky.hourly(lat, lon, 48);
  S.hourly = h.weather || [];
  S.daily = await BrightSky.daily(lat, lon, 8);
  setHero(); renderHourlyChart(); renderDaily();
}

function setBuild(){
  const b = $("#buildInfo"); const now = new Date(); b.textContent = now.toISOString().slice(0,10);
}

function wire(){
  $("#langBtn").addEventListener("click", ()=>{ lang = lang==="de"?"en":"de"; applyI18n(); setHero(); renderHourlyChart(); renderDaily(); });
  $("#geoBtn").addEventListener("click", async ()=>{
    if(!("geolocation" in navigator)){ alert("Geolocation not available"); return; }
    navigator.geolocation.getCurrentPosition(async pos=>{
      const {latitude:lat, longitude:lon} = pos.coords;
      $("#coord").value = `${lat.toFixed(5)},${lon.toFixed(5)}`;
      try{ await loadAll(lat, lon); }catch(e){ console.error(e); alert("API Fehler"); }
    }, err=>alert(err.message), {enableHighAccuracy:true, timeout:10000});
  });
  $("#goBtn").addEventListener("click", async ()=>{
    const val = $("#coord").value.trim();
    const m = val.match(/^\s*([+-]?\d+(\.\d+)?)\s*,\s*([+-]?\d+(\.\d+)?)\s*$/);
    if(!m) { alert("Bitte lat,lon eingeben (z. B. 52.52,13.40)"); return; }
    const lat=+m[1], lon=+m[3];
    try{ await loadAll(lat, lon); }catch(e){ console.error(e); alert("API Fehler"); }
  });
}

async function init(){
  setBuild(); applyI18n(); wire();
  let loaded = false;
  const loadFallback = async ()=>{
    if(loaded) return;
    try{
      await loadAll(52.52, 13.405);
      loaded = true;
    }catch(err){ console.error(err); }
  };
  try{
    const qs = new URLSearchParams(location.search);
    if(qs.has("lat") && qs.has("lon")){
      await loadAll(+qs.get("lat"), +qs.get("lon"));
      loaded = true;
    }else{
      try{
        const pos = await requestPosition({enableHighAccuracy:true, timeout:10000});
        const {latitude:lat, longitude:lon} = pos.coords;
        $("#coord").value = `${lat.toFixed(5)},${lon.toFixed(5)}`;
        await loadAll(lat, lon);
        loaded = true;
      }catch(geoError){
        console.warn("Auto geolocation failed", geoError);
      }
    }
  }catch(e){ console.error(e); }
  await loadFallback();
  if("serviceWorker" in navigator){
    try{ await navigator.serviceWorker.register("./sw.js"); }catch(e){ console.warn("SW failed", e); }
  }
}
init();
</script>
</body>
</html>
